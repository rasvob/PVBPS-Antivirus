using System.Collections.Generic;
using System.Linq;
using AntiVirusLib.Database;
using AntiVirusLib.Models;
using AntiVirusLib.Signatures;

namespace AntiVirusLib.Scanner
{
    public class MalwareScanner
    {
        private readonly string _yaraPath;
        private readonly string _index;
        private readonly string _custom;
        private readonly string _db;
        private readonly string _quarantine;
        private readonly string _apiKey;

        private readonly IMapper<FileModel> _mapper;
        private readonly YaraGateway _yara;

        public MalwareScanner(string yara, string index, string custom, string db, string quarantine, string apiKey)
        {
            _yaraPath = yara;
            _index = index;
            _custom = custom;
            _db = db;
            _quarantine = quarantine;
            _apiKey = apiKey;

            _mapper = new DatabaseMapper(_db);
            _yara = new YaraGateway(_yaraPath);
        }

        public void FastScan(FileModel model)
        {
            model.ComputeHashes();
            FileModel one = _mapper.FindOne(model.Sha256Hash);

            if (one != null)
            {
                model.RefreshModel(one);
                return;
            }

            IEnumerable<string> indexFile = _yara.ScanFile(model.FilePath, _index);
            IEnumerable<string> customFile = _yara.ScanFile(model.FilePath, _custom);

            model.MatchedSignatures.Clear();
            model.MatchedSignatures.AddRange(indexFile.Concat(customFile));
        }

        public void DeepScan(FileModel model)
        {
            FastScan(model);
        }
    }
}