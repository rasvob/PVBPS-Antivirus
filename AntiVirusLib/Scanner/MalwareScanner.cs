using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AntiVirusLib.Database;
using AntiVirusLib.Models;
using AntiVirusLib.Signatures;
using AntiVirusLib.VirusTotal;

namespace AntiVirusLib.Scanner
{
    public class MalwareScanner
    {
        private readonly string _yaraPath;
        private readonly string _index;
        private readonly string _custom;
        private readonly string _db;
        private readonly string _quarantine;
        private readonly string _apiKey;

        private readonly IMapper<FileModel> _mapper;
        private readonly YaraGateway _yara;
        private readonly VirusTotalGateway _virusTotalGateway;

        //TODO: Move to quarantine
        public MalwareScanner(string yara, string index, string custom, string db, string quarantine, string apiKey)
        {
            _yaraPath = yara;
            _index = index;
            _custom = custom;
            _db = db;
            _quarantine = quarantine;
            _apiKey = apiKey;

            _mapper = new DatabaseMapper(_db);
            _yara = new YaraGateway(_yaraPath);
            _virusTotalGateway = new VirusTotalGateway(_apiKey);
        }

        public async Task FastScan(FileModel model)
        {
            model.ComputeHashes();
            model.ScanTime = DateTime.Now;
            FileModel one = _mapper.FindOne(model.Sha256Hash);

            if (one != null)
            {
                model.IsClean = false;
            }

            await Task.Factory.StartNew(() =>
            {
                IEnumerable<string> indexFile = _yara.ScanFile(model.FilePath, _index);
                IEnumerable<string> customFile = _yara.ScanFile(model.FilePath, _custom);
                var file = customFile as string[] ?? customFile.ToArray();
                var indexArr = indexFile as string[] ?? indexFile.ToArray();

                if (file.Any() || indexArr.Count() > 6)
                {
                    model.IsClean = false;
                }

                model.MatchedSignatures.Clear();
                model.MatchedSignatures.AddRange(indexArr.Concat(file));
            });

            bool scanRe = await _virusTotalGateway.FastScanFile(model);

            if (scanRe)
            {
                if (model.VirusTotalReport.Positives > (double)model.VirusTotalReport.Total*20/100)
                {
                    model.IsClean = false;
                }
            }
        }

        public async Task DeepScan(FileModel model)
        {
            await FastScan(model);

            if (model.VirusTotalReport.ScanId is null)
            {
                bool scanRe = await _virusTotalGateway.DeepScanFile(model);

                if (scanRe)
                {
                    if (model.VirusTotalReport.Positives > (double)model.VirusTotalReport.Total * 20 / 100)
                    {
                        model.IsClean = false;
                    }
                }
            }
        }

        public void SaveToDb(FileModel model)
        {
            _mapper.Save(model);
        }
    }
}